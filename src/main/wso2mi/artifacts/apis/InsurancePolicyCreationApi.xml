<?xml version="1.0" encoding="UTF-8"?>
<api context="/insurance/1.0.0/policy_creation" name="InsurancePolicyCreationApi"
    xmlns="http://ws.apache.org/ns/synapse">
    <resource methods="POST" uri-template="/insurance/1.0.0/policy_creation">
        <inSequence>
            <log category="INFO" logMessageID="false">
                <message>............................................Insurance Policy Creation API request received........................................</message>
            </log>
            <validate source="json-eval($)" cache-schema="true">
                <schema key="resources:json/RequestValidationSchema.json" />
                <on-fail>
                    <payloadFactory media-type="json" template-type="default">
                        <format>{"ResponseHeader": { "status":"Error", "RequestId":12345,
                            "ErrorMessage":"$1"}}</format>
                        <args>
                            <arg expression="$ctx:ERROR_MESSAGE" evaluator="xml" />
                        </args>
                    </payloadFactory>
                    <property name="HTTP_SC" value="400" scope="axis2" />
                    <respond />
                </on-fail>
            </validate>
            <variable name="FIRST_NAME" type="STRING" expression="${payload.PolicyHolder.FirstName}" />
            <variable name="LAST_NAME" type="STRING" expression="${payload.PolicyHolder.LastName}" />
            <variable name="DOB" type="STRING" expression="${payload.PolicyHolder.DateOfBirth}" />
            <variable name="EMAIL" type="STRING"
                expression="${payload.PolicyHolder.ContactInfo.Email}" />
            <variable name="MOBILE" type="STRING"
                expression="${payload.PolicyHolder.ContactInfo.Phone}" />
            <variable name="PolicyDetailsPolicyType" type="STRING"
                expression="${payload.PolicyDetails.PolicyType}" />
            <variable name="PAYMENT_METHOD" type="STRING"
                expression="${payload.PaymentInfo.PaymentMethod}" />
            <propertyGroup>
                <property name="gender" scope="default" type="STRING"
                    expression="${payload.PolicyHolder.Gender}" action="set" />
                <property name="street" scope="default" type="STRING"
                    expression="${payload.PolicyHolder.ContactInfo.Address.Street}" action="set" />
                <property name="city" scope="default" type="STRING"
                    expression="${payload.PolicyHolder.ContactInfo.Address.City}" action="set" />
                <property name="state" scope="default" type="STRING"
                    expression="${payload.PolicyHolder.ContactInfo.Address.State}" action="set" />
                <property name="zip_code" scope="default" type="STRING"
                    expression="${payload.PolicyHolder.ContactInfo.Address.ZipCode}" action="set" />
                <property name="country" scope="default" type="STRING"
                    expression="${payload.PolicyHolder.ContactInfo.Address.Country}" action="set" />
                <property name="primary_coverage_amount" scope="default" type="INTEGER"
                    expression="${payload.PolicyDetails.PrimaryCoverageAmount}" action="set" />
                <property name="premium_amount" scope="default" type="INTEGER"
                    expression="${payload.PolicyDetails.PremiumAmount}" action="set" />
                <property name="start_date" scope="default" type="STRING"
                    expression="${payload.PolicyDetails.StartDate}" action="set" />
                <property name="end_date" scope="default" type="STRING"
                    expression="${payload.PolicyDetails.EndDate}" action="set" />
                <property name="payment_frequency" scope="default" type="STRING"
                    expression="${payload.PolicyDetails.PaymentFrequency}" action="set" />
                <property name="b_firstname" scope="default" type="STRING"
                    expression="${payload.Beneficiaries[0].FirstName}" action="set" />
                <property name="b_lastname" scope="default" type="STRING"
                    expression="${payload.Beneficiaries[0].LastName}" action="set" />
                <property name="b_date_of_birth" scope="default" type="STRING"
                    expression="${payload.Beneficiaries[0].DateOfBirth}" action="set" />
                <property name="b_percentage_share" scope="default" type="STRING"
                    expression="${payload.Beneficiaries[0].PercentageShare}" action="set" />
                <property name="card_number" scope="default" type="STRING"
                    expression="${payload.PaymentInfo.CardNumber}" action="set" />
                <property name="card_exp_date" scope="default" type="STRING"
                    expression="${payload.PaymentInfo.CardExpiryDate}" action="set" />
                <property name="card_cvv" scope="default" type="STRING"
                    expression="${payload.PaymentInfo.CardCvv}" action="set" />
            </propertyGroup>

            <header name="x-api-key" expression="wso2:vault-lookup('x-api-key')" scope="transport"/>
            <call>
                <endpoint key="ListInsurancePolicyEndpoint" />
            </call>
            <property name="HTTP_STATUS" expression="$axis2:HTTP_SC" scope="default" type="STRING" />
            <filter xpath="$ctx:HTTP_STATUS != '200'">
                <then>
                    <payloadFactory media-type="json">
                        <format>{"ResponseHeader": {"Status": "Error", "RequestId": "$1",
                            "ErrorMessage": "List Insurance Policy Types API failed with status:
                            $2"}}</format>
                        <args>
                            <arg expression="$ctx:RequestId" evaluator="xml" />
                            <arg expression="$ctx:HTTP_STATUS" evaluator="xml" />
                        </args>
                    </payloadFactory>
                    <property name="HTTP_SC" value="500" scope="axis2" />
                    <respond />
                </then>
                <else>
                    <property name="policyTypes" expression="json-eval($.policy_types)"
                        scope="default" />
                </else>
            </filter>


            <iterate expression="json-eval($.policy_types)" continueParent="true" sequential="true">
                <target>
                    <sequence>
                        <variable name="currentPolicyId" type="STRING"
                            expression="json-eval($.policy_type_id)" />
                        <variable name="currentPolicyName" type="STRING"
                            expression="json-eval($.name)" />

                        <filter xpath="${vars.PolicyDetailsPolicyType == vars.currentPolicyId}">
                            <then>


                                <payloadFactory media-type="json" template-type="default">
                                    <format> { "insertInsurancePolicy": {
                                        "FIRST_NAME":"${vars.FIRST_NAME}",
                                        "LAST_NAME":"${vars.LAST_NAME}", "DOB": "${vars.DOB}",
                                        "EMAIL":"${vars.EMAIL}", "MOBILE": "${vars.MOBILE}",
                                        "POLICY_TYPE_ID":"${vars.currentPolicyId}",
                                        "PAYMENT_METHOD":"${vars.PAYMENT_METHOD}" } } </format>
                                </payloadFactory>

                                <payloadFactory media-type="xml" template-type="default">
                                    <format>
                                        <insertInsurancePolicy xmlns="http://ws.apache.org/ns/data">
                                            <FIRST_NAME>
                                                $1</FIRST_NAME>
                                            <LAST_NAME>$2</LAST_NAME>
                                            <DOB>$3</DOB>
                                            <EMAIL>$4</EMAIL>
                                            <MOBILE>$5</MOBILE>
                                            <POLICY_TYPE_ID>$6</POLICY_TYPE_ID>
                                            <PAYMENT_METHOD>
                                                $7</PAYMENT_METHOD>
                                        </insertInsurancePolicy>
                                    </format>
                                    <args>
                                        <arg evaluator="json"
                                            expression="$.insertInsurancePolicy.FIRST_NAME" />
                                        <arg evaluator="json"
                                            expression="$.insertInsurancePolicy.LAST_NAME" />
                                        <arg evaluator="json"
                                            expression="$.insertInsurancePolicy.DOB" />
                                        <arg evaluator="json"
                                            expression="$.insertInsurancePolicy.EMAIL" />
                                        <arg evaluator="json"
                                            expression="$.insertInsurancePolicy.MOBILE" />
                                        <arg evaluator="json"
                                            expression="$.insertInsurancePolicy.POLICY_TYPE_ID" />
                                        <arg evaluator="json"
                                            expression="$.insertInsurancePolicy.PAYMENT_METHOD" />
                                    </args>
                                </payloadFactory>

                                <property name="firstname" scope="default" type="STRING"
                                    expression="${vars.FIRST_NAME}" />
                                <property name="LAST_NAME" scope="default" type="STRING"
                                    expression="${vars.LAST_NAME}" />
                                <property name="DOB" scope="default" type="STRING"
                                    expression="${vars.DOB}" />
                                <property name="EMAIL" scope="default" type="STRING"
                                    expression="${vars.EMAIL}" />
                                <property name="MOBILE" scope="default" type="STRING"
                                    expression="${vars.MOBILE}" />
                                <property name="POLICY_TYPE_ID" scope="default" type="STRING"
                                    expression="${vars.currentPolicyId}" />
                                <property name="PAYMENT_METHOD" scope="default" type="STRING"
                                    expression="${vars.PAYMENT_METHOD}" />


                                <dataServiceCall serviceName="InsuranceCreationService">
                                    <operations type="single">
                                        <operation name="insertInsurancePolicy">
                                            <param name="FIRST_NAME" expression="$ctx:firstname"
                                                evaluator="xml" />
                                            <param name="LAST_NAME" expression="$ctx:LAST_NAME"
                                                evaluator="xml" />
                                            <param name="DOB" expression="$ctx:DOB" evaluator="xml" />
                                            <param name="EMAIL" expression="$ctx:EMAIL"
                                                evaluator="xml" />
                                            <param name="MOBILE" expression="$ctx:MOBILE"
                                                evaluator="xml" />
                                            <param name="POLICY_TYPE_ID"
                                                expression="$ctx:POLICY_TYPE_ID" evaluator="xml" />
                                            <param name="PAYMENT_METHOD"
                                                expression="$ctx:PAYMENT_METHOD" evaluator="xml" />
                                        </operation>
                                    </operations>
                                    <source type="inline" />
                                    <target type="property" name="insertResponse" />
                                </dataServiceCall>

                                <property name="DID"
                                    expression="$ctx:insertResponse//*[local-name()='DID']/text()"
                                    scope="operation"
                                    type="STRING" />

                                <filter xpath="string-length($ctx:DID) > 0">
                                    <then>
                                        <log category="INFO" logMessageID="false">
                                            <property name="SUCCESS_MESSAGE"
                                                value="DID successfully extracted" />
                                            <property name="DID_VALUE" expression="$ctx:DID" />
                                        </log>
                                    </then>
                                    <else>
                                        <log category="ERROR" logMessageID="false">
                                            <property name="ERROR_MESSAGE"
                                                value="Failed to extract DID from response" />
                                            <property name="RAW_RESPONSE"
                                                expression="$ctx:insertResponse" />
                                        </log>
                                    </else>
                                </filter>

                            </then>
                            <else>

                            </else>
                        </filter>
                    </sequence>
                </target>
            </iterate>

            <payloadFactory media-type="json" template-type="default">
                <format>{ "policy_holder": { "first_name": "${vars.FIRST_NAME}", "last_name":
                    "${vars.LAST_NAME}", "date_of_birth": "${vars.DOB}", "gender":
                    "${properties.synapse.gender}", "contact_info": { "email": "${vars.EMAIL}",
                    "phone": "${vars.MOBILE}", "address": { "street":
                    "${properties.synapse.street}", "city": "${properties.synapse.city}", "state":
                    "${properties.synapse.state}", "zip_code": "${properties.synapse.zip_code}",
                    "country": "${properties.synapse.country}" } } }, "policy_details": {
                    "policy_type": "${vars.currentPolicyId}", "primary_coverage_amount":
                    ${properties.synapse.primary_coverage_amount}, "premium_amount":
                    ${properties.synapse.premium_amount}, "start_date":
                    "${properties.synapse.start_date}", "end_date":
                    "${properties.synapse.end_date}", "payment_frequency":
                    "${properties.synapse.payment_frequency}" }, "beneficiaries": [ { "first_name":
                    "${properties.synapse.b_firstname}", "last_name":
                    "${properties.synapse.b_lastname}", "date_of_birth":
                    "${properties.synapse.b_date_of_birth}", "relationship": "Spouse",
                    "percentage_share": ${properties.synapse.b_percentage_share} } ],
                    "payment_info": { "payment_method": "${vars.PAYMENT_METHOD}", "card_number":
                    "${properties.synapse.card_number}", "card_expiry_date":
                    "${properties.synapse.card_exp_date}", "card_cvv":
                    "${properties.synapse.card_cvv}" } }</format>
            </payloadFactory>


            <header name="x-api-key" expression="wso2:vault-lookup('x-api-key')" scope="transport"/>

            <call>
                <endpoint key="InsurancePolicyCreationEndpoint" />
            </call>
            <property name="HTTP_STATUS" expression="$axis2:HTTP_SC" scope="default" type="STRING" />
            <filter xpath="$ctx:HTTP_STATUS != '200'">
                <then>
                    <payloadFactory media-type="json">
                        <format>{"ResponseHeader": {"Status": "Error", "RequestId": "$1",
                            "ErrorMessage": "Insurance Policy Creation API failed with status: $2"}}</format>
                        <args>
                            <arg expression="$ctx:RequestId" evaluator="xml" />
                            <arg expression="$ctx:HTTP_STATUS" evaluator="xml" />
                        </args>
                    </payloadFactory>
                    <property name="HTTP_SC" value="500" scope="axis2" />
                    <respond />
                </then>
                <else>
                    <property name="mockResponse" expression="json-eval($)" scope="default" />
                </else>
            </filter>

            
            <property name="POLICY_ID" expression="json-eval($.policy_id)" scope="default"
                type="STRING" />

            
            <property name="EMAIL" expression="$ctx:EMAIL" scope="default" type="STRING" />
            <property name="DID" expression="get-property('operation','DID')
" scope="default"
                type="STRING" />
            <property name="CURRENT_TIMESTAMP" expression="get-property('SYSTEM_DATE')"
                scope="default" type="STRING" />

            


            <payloadFactory media-type="json">
                <format>{"MESSAGE_TYPE": "POLICY_ID_UPDATE", "POLICY_ID": "$1", "DID": "$2",
                    "UPDATED_AT": "$4"}</format>
                <args>
                    <arg evaluator="xml" expression="$ctx:POLICY_ID" />
                    <arg evaluator="xml" expression="$ctx:DID" />
                    <arg evaluator="xml" expression="$ctx:EMAIL" />
                    <arg evaluator="xml" expression="$ctx:CURRENT_TIMESTAMP" />
                </args>
            </payloadFactory>

            <store messageStore="INS_DSS_QUEUE" sequence="MessageRouterSequence" />

            <payloadFactory media-type="json">
                <format>{"MESSAGE_TYPE": "POLICY_ID_UPDATE", "POLICY_ID": "$1", "DID": "$2",
                    "EMAIL": "$3", "UPDATED_AT": "$4"}</format>
                <args>
                    <arg evaluator="xml" expression="$ctx:POLICY_ID" />
                    <arg evaluator="xml" expression="$ctx:DID" />
                    <arg evaluator="xml" expression="$ctx:EMAIL" />
                    <arg evaluator="xml" expression="$ctx:CURRENT_TIMESTAMP" />
                </args>
            </payloadFactory>


            <log category="INFO" logMessageID="false">
                <property name="FINAL_RESPONSE_PAYLOAD" expression="json-eval($)" />
            </log>

            <respond />
        </inSequence>
        <faultSequence>

            <payloadFactory media-type="json">
                <format>{"ResponseHeader": {"Status": "Error", "RequestId": "$1", "ErrorMessage":
                    "$2"}}</format>
                <args>
                    <arg expression="$ctx:RequestId" evaluator="xml" />
                    <arg expression="$ctx:ERROR_MESSAGE" evaluator="xml" />
                </args>
            </payloadFactory>
            <property name="HTTP_SC" value="500" scope="axis2" />
            <respond />
        </faultSequence>
    </resource>
</api>